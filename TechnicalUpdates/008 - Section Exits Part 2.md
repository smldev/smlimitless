# Super Mario Limitless

## Technical Update #008 - Section Exits Part 2

This document will cover:

	* How levels will support changing sections
	* How the level editor will handle multiple sections
	* How the level editor will handle editing section exits
	* How section exits are stored to level files

### Description

#### Changing Sections in Levels

Levels are composed of multiple sections. Each section has two elements to identify itself; an `int Index` property and a `string Name` property. The name is is mostly for display purposes, but the ID is used by the level and anything that needs to reference sections in a level, such as section exits. Both name and ID must be unique in a level.

Levels store sections using the `List<Section> Sections` property and the section currently running in the `Section ActiveSection` property. Only the active section is drawn and updated, all others have essentially frozen and will remain as they are until they are reloaded.

Section exits have their own way of changing the active section, through the `void ChangeActiveSectionForExit(Section, Vector2, SectionExit, SectionExit)` and `void OnSectionExit(SectionExit)` methods. The other primary way of changing sections will be the `void ChangeSection(int)` method.

#### Level Editor Section Selector

Mockup: ![Mockup](http://i.imgur.com/8mh9BZW.png)

The above is a markup for the section selector. The ID of each section is not user-editable, as it is generated by the game, specifically an `IDGenerator` instance in the `Level` class. The ID display may be removed in future versions.

The user may select any section and modify its name, switch to the section in the level editor, or delete it. A section's name must be unique (the user cannot name two sections the same). The user will be asked to confirm the deletion of a section.

**Level files will now be able to mark a section as the "Start" section.** Start sections are the first sections loaded when the level is played or edited. The `"isStart"` key will be added to sections in Serializer v0.03.

In the section selector, start sections are marked in **bold** text. The user can press the "Set as Start" to change the start section.

The "Switch To" button will immediately change the section being displayed. *Sections will now remember the last camera position they had while in the editor*. These last camera positions will be reset whenever the editor is closed.

Double-clicking a section in the listbox will also switch the level editor to that section. Press Ctrl+Left and Ctrl+Right to switch to the previous or next section on the list at any time. Pressing the Delete key with a section selected will ask the user to confirm section deletion.

The ordering of the sections in the selector is determined by their order in the level file but is not relevant.

#### Editing Section Exits

Mockup: ![Mockup](http://i.imgur.com/Mog1oBj.png)

The above is a markup for the section exit editor. *An "Update" button will be added to the implementation, beneath the "Destination" groupbox.*

To create a new exit:

	1. Click "New".
	2. The editor will prompt you to left-click where you want the source of the exit. A rectangle will be shown under your cursor. You can switch between sections here.
	3. The editor will then prompt you to left-click for the destination of the exit.
	4. Upon placing the exit, the controls enable, allowing the user to select the behavior or modify the position.

To modify an existing exit:

	1. Click either the source or the destination in the editor.
	2. The controls will enable in the section exit editor and the level editor form will automatically switch to the section exit tab.
	3. Modify the properties as you see fit.
	4. Click "Update".
	
To delete an exit:

	1. Click either the source or destination in the editor.
	2. Click "Delete".
	3. Click "Yes" on the confirmation dialog box.
	
Section exits will appear in the level editor as one-pixel thick rectangle outlines. Sources are green and exits are red. A small number displaying the ID will be above the exit.

For now, all section exits shall have a size of `GameServices.GameObjectSize`. Editing sizes will be implemented in future versions.

#### Saving Section Exits to the Level File
A `"sectionExits"` key will be added to the section object in the level file. This key will be an object containing the following values:

	* `id`
	* `otherID`
	* `sourceBehavior`
	* `destinationBehavior`
	* `position`
	* `size`
	
### Implementation

	* Modifications to `Level`:
		* `void ChangeSection(int)`: Changes the current section. Throws `ArgumentException` for an section index that doesn't exist.
	* Modifications to `Section`:
		* `bool IsStartSection {get; internal set;}`
	* Modifications to `EditorSelectedObjectType`
		* `NewSectionExitSource`
		* `NewSectionExitDestination`
		* `void Draw()`: draws green/red rectangle outline if the selected object is a new section exit.
		* `void NewSectionExit()`: Switches the editor selected object to place a new section exit source.
		* `void OnLeftClick()`:
			* When the selected object is a new section exit source, a left click places the source and switches the selected object to a new section exit destination.
			* When the selected object is a new section exit destination, a left click places the destination and switches the selected object to nothing.
	* Modifications to `EditorForm`: see mockups
	* Modifications to the level file:
		* Member of `sections` array:
			* New key `isStart` (boolean)
			* New array `sectionExits`
		* Member of `sectionExits` array:
			* New key `id` (number)
			* New key `otherID` (number)
			* New key `sourceBehavior` (enum -> number)
			* New key `destinationBehavior` (enum -> number)
			* New key `position` (Vector2 -> string)
			* New key `size` (Vector2 -> string)